/**
 * Demo Home Page - Same layout and components as production HomeFeed
 * 
 * Uses same UI components (CompactEventCard, NetworkReviewCard, etc.) but with hardcoded mock data.
 * NO API calls - all data is from mockData.ts
 */

import React, { useState } from 'react';
import { useNavigate } from 'react-router-dom';
import { MobileHeader } from '@/components/Header/MobileHeader';
import { CompactEventCard } from '@/components/home/CompactEventCard';
import { NetworkReviewCard } from '@/components/home/NetworkReviewCard';
import { DEMO_USER, DEMO_EVENTS, DEMO_REVIEWS } from '../data/mockData';
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuTrigger,
} from '@/components/ui/dropdown-menu';
import { Button } from '@/components/ui/button';
import { ChevronDown } from 'lucide-react';
import { EventDetailsModal } from '@/components/events/EventDetailsModal';
import type { PersonalizedEvent } from '@/services/personalizedFeedService';

interface DemoHomePageProps {
  menuOpen?: boolean;
  onMenuClick?: () => void;
  onNavigate?: (page: 'home' | 'discover' | 'profile' | 'messages' | 'create-post') => void;
}

export const DemoHomePage: React.FC<DemoHomePageProps> = ({
  menuOpen = false,
  onMenuClick,
  onNavigate,
}) => {
  const navigate = useNavigate();
  const [selectedFeedType, setSelectedFeedType] = useState('recommended');
  const [selectedEvent, setSelectedEvent] = useState<any>(null);
  const [eventDetailsOpen, setEventDetailsOpen] = useState(false);
  const [selectedEventInterested, setSelectedEventInterested] = useState(false);

  const feedTypes = [
    { value: 'recommended', label: 'Hand Picked Events' },
    { value: 'trending', label: 'Trending' },
    { value: 'friends', label: 'Friends' },
    { value: 'reviews', label: 'Reviews' },
  ];

  const handleEventClick = (eventId: string) => {
    const event = DEMO_EVENTS.find(e => e.id === eventId);
    if (event) {
      setSelectedEvent(event);
      setSelectedEventInterested(false);
      setEventDetailsOpen(true);
    }
  };

  const handleInterestToggle = async (eventId: string, interested: boolean) => {
    console.log('Demo: Toggle interest', eventId, interested);
    setSelectedEventInterested(interested);
  };

  const handleAttendanceToggle = async (eventId: string, attended: boolean) => {
    console.log('Demo: Toggle attendance', eventId, attended);
  };

  // Convert demo events to PersonalizedEvent format
  const demoPersonalizedEvents: PersonalizedEvent[] = DEMO_EVENTS.map(event => ({
    id: event.id,
    title: event.title,
    artist_name: event.artist_name,
    venue_name: event.venue_name,
    venue_city: event.venue_city,
    event_date: event.event_date,
    poster_image_url: event.poster_image_url,
    images: event.images,
    price_range: event.price_range,
    genres: event.genres,
    interested_count: Math.floor(Math.random() * 50),
    user_is_interested: false,
  }));

  // Convert demo reviews to NetworkReview format
  const demoNetworkReviews = DEMO_REVIEWS.slice(0, 10).map(review => {
    const event = DEMO_EVENTS.find(e => e.id === review.event_id);
    return {
      id: review.id,
      author: {
        id: DEMO_USER.id,
        name: DEMO_USER.name,
        avatar_url: DEMO_USER.avatar_url || undefined,
      },
      created_at: review.created_at,
      rating: review.rating,
      content: review.review_text || undefined,
      photos: review.photos || undefined,
      event_info: {
        artist_name: event?.artist_name,
        venue_name: event?.venue_name,
        event_date: event?.event_date,
      },
    };
  });

  return (
    <div
      className="min-h-screen bg-[#fcfcfc]"
      style={{
        paddingBottom: 'var(--spacing-bottom-nav, 112px)',
      }}
    >
      {/* Mobile Header with dropdown - EXACT same as production */}
      <MobileHeader menuOpen={menuOpen} onMenuClick={onMenuClick}>
        <div className="flex justify-center w-full">
          <DropdownMenu>
            <DropdownMenuTrigger asChild>
              <Button variant="outline" className="flex items-center gap-2 bg-white" data-tour="feed-toggle">
                {feedTypes.find(ft => ft.value === selectedFeedType)?.label || 'Hand Picked Events'}
                <ChevronDown className="h-4 w-4" />
              </Button>
            </DropdownMenuTrigger>
            <DropdownMenuContent className="bg-white">
              {feedTypes.map((feedType) => (
                <DropdownMenuItem
                  key={feedType.value}
                  onClick={() => setSelectedFeedType(feedType.value)}
                >
                  {feedType.label}
                </DropdownMenuItem>
              ))}
            </DropdownMenuContent>
          </DropdownMenu>
        </div>
      </MobileHeader>

      {/* Feed Content - EXACT same structure as production */}
      <div className="max-w-7xl mx-auto pb-6" style={{ paddingLeft: 'var(--spacing-screen-margin-x, 20px)', paddingRight: 'var(--spacing-screen-margin-x, 20px)' }}>
        {selectedFeedType === 'recommended' && (
          <div className="space-y-4">
            {/* Events Grid - EXACT same as PreferencesV4FeedSection */}
            <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-3">
              {demoPersonalizedEvents.map((event, index) => {
                // Resolve image URL with priority - EXACT same logic as production
                let imageUrl: string | undefined = undefined;
                let isCommunityPhoto = false;
                
                if (event.poster_image_url) {
                  imageUrl = event.poster_image_url;
                  // Check if this is a community photo (from user review)
                  // For demo: Arctic Monkeys event (event-3) should show as community photo
                  if (event.id === 'event-3') {
                    isCommunityPhoto = true;
                  } else {
                    // Use same detection logic as production
                    const isInImagesArray = event.images && Array.isArray(event.images) && 
                      event.images.some((img: any) => img?.url === event.poster_image_url);
                    const isSupabaseStorageUrl = event.poster_image_url?.includes('/storage/v1/object/public/') || 
                      event.poster_image_url?.includes('review-photos') ||
                      event.poster_image_url?.includes('supabase.co/storage');
                    
                    if (!isInImagesArray && !(event as any).event_media_url) {
                      isCommunityPhoto = true;
                    } else if (isSupabaseStorageUrl) {
                      isCommunityPhoto = true;
                    }
                  }
                } else if (event.images && Array.isArray(event.images) && event.images.length > 0) {
                  const bestImage = event.images.find((img: any) => 
                    img?.url && (img?.ratio === '16_9' || (img?.width && img.width > 1000))
                  ) || event.images.find((img: any) => img?.url);
                  imageUrl = bestImage?.url;
                }
                
                return (
                  <CompactEventCard
                    key={`${event.id}-${index}`}
                    event={{
                      id: event.id || '',
                      title: event.title || event.artist_name || 'Event',
                      artist_name: event.artist_name,
                      venue_name: event.venue_name,
                      event_date: event.event_date,
                      venue_city: event.venue_city || undefined,
                      image_url: imageUrl,
                      poster_image_url: event.poster_image_url || undefined,
                    }}
                    interestedCount={(event.interested_count || 0) + (event.user_is_interested ? 1 : 0)}
                    isInterested={event.user_is_interested || false}
                    isCommunityPhoto={isCommunityPhoto}
                    onClick={() => handleEventClick(event.id)}
                  />
                );
              })}
            </div>
          </div>
        )}
        {selectedFeedType === 'trending' && (
          <div className="space-y-4">
            <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-3">
              {DEMO_EVENTS.slice(0, 12).map((event) => {
                // Arctic Monkeys event should show community photo tag
                const isCommunityPhoto = event.id === 'event-3';
                return (
                  <CompactEventCard
                    key={event.id}
                    event={{
                      id: event.id,
                      title: event.title,
                      artist_name: event.artist_name,
                      venue_name: event.venue_name,
                      event_date: event.event_date,
                      venue_city: event.venue_city,
                      image_url: event.poster_image_url,
                      poster_image_url: event.poster_image_url,
                    }}
                    isCommunityPhoto={isCommunityPhoto}
                    onClick={() => handleEventClick(event.id)}
                  />
                );
              })}
            </div>
          </div>
        )}
        {selectedFeedType === 'friends' && (
          <div className="space-y-4">
            <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-3">
              {DEMO_EVENTS.slice(0, 12).map((event) => {
                // Arctic Monkeys event should show community photo tag
                const isCommunityPhoto = event.id === 'event-3';
                return (
                  <CompactEventCard
                    key={event.id}
                    event={{
                      id: event.id,
                      title: event.title,
                      artist_name: event.artist_name,
                      venue_name: event.venue_name,
                      event_date: event.event_date,
                      venue_city: event.venue_city,
                      image_url: event.poster_image_url,
                      poster_image_url: event.poster_image_url,
                    }}
                    isCommunityPhoto={isCommunityPhoto}
                    onClick={() => handleEventClick(event.id)}
                  />
                );
              })}
            </div>
          </div>
        )}
        {selectedFeedType === 'reviews' && (
          <div className="space-y-4">
            <div className="space-y-3">
              {demoNetworkReviews.map((review) => (
                <NetworkReviewCard
                  key={review.id}
                  review={review}
                  onClick={() => console.log('Demo: Review clicked', review.id)}
                />
              ))}
            </div>
          </div>
        )}
      </div>

      {/* Event Details Modal - EXACT same as production */}
      {selectedEvent && (
        <EventDetailsModal
          event={selectedEvent as any}
          currentUserId={DEMO_USER.id}
          isOpen={eventDetailsOpen}
          onClose={() => setEventDetailsOpen(false)}
          onInterestToggle={handleInterestToggle}
          onAttendanceChange={handleAttendanceToggle}
          isInterested={selectedEventInterested}
          hasReviewed={false}
        />
      )}
    </div>
  );
};
